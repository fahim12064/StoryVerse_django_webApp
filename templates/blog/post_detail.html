{% extends 'base.html' %}
{% block title %}{{ post.title }} - StoryVerse{% endblock %}

{% block content %}
<article class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
    {% if post.cover_image %}
        <div class="h-96 bg-gray-100 dark:bg-gray-700">
            <img src="{{ post.cover_image.url }}" alt="{{ post.title }}" class="w-full h-full object-contain">
        </div>
    {% endif %}
    
    <div class="p-6">
        <div class="flex justify-between items-start mb-4">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">{{ post.title }}</h1>
            
            {% if user == post.author %}
                <div class="flex space-x-2">
                    <a href="{% url 'blog:edit_post' post.pk %}" class="text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{% url 'blog:delete_post' post.pk %}" class="text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            {% endif %}
        </div>
        
        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 mb-6">
            <a href="{% url 'accounts:profile' post.author.username %}" class="flex items-center hover:text-blue-600 dark:hover:text-blue-400 transition">
                {% if post.author.profile.profile_picture %}
                    <img src="{{ post.author.profile.profile_picture.url }}" alt="{{ post.author.username }}" class="w-8 h-8 rounded-full object-cover mr-2">
                {% else %}
                    <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center mr-2">
                        <span class="text-gray-600 dark:text-gray-300 text-xs">{{ post.author.username|first|upper }}</span>
                    </div>
                {% endif %}
                {{ post.author.username }}
            </a>
            <span class="mx-2">•</span>
            <span>{{ post.created_at|date:"F d, Y" }}</span>
            
            {% if post.category %}
                <span class="mx-2">•</span>
                <a href="{% url 'blog:category_posts' post.category.id %}" class="text-blue-600 dark:text-blue-400 hover:underline">{{ post.category.name }}</a>
            {% endif %}
            
            {% if post.subcategory %}
                <span class="mx-2">•</span>
                <a href="{% url 'blog:subcategory_posts' post.subcategory.id %}" class="text-blue-600 dark:text-blue-400 hover:underline">{{ post.subcategory.name }}</a>
            {% endif %}
        </div>
        
        <div class="prose max-w-none text-gray-700 dark:text-gray-300 mb-8">
            {{ post.content|linebreaks }}
        </div>
        
        <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex space-x-4">
                {% if user.is_authenticated %}
                    <button class="like-btn flex items-center text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition {% if is_liked %}text-red-500 dark:text-red-400{% endif %}" data-post-id="{{ post.id }}" data-liked="{{ is_liked|yesno:'true,false' }}">
                        <i class="{% if is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                        <span class="likes-count ml-1">{{ post.likes_count }}</span>
                    </button>
                {% else %}
                    <div class="flex items-center text-gray-500 dark:text-gray-400">
                        <i class="far fa-heart"></i>
                        <span class="ml-1">{{ post.likes_count }}</span>
                    </div>
                {% endif %}
                
                <div class="flex items-center text-gray-500 dark:text-gray-400">
                    <i class="far fa-comment"></i>
                    <span class="ml-1" id="comments-count">{{ post.comments_count }}</span>
                </div>
            </div>
            
            <div class="flex space-x-2">
                <a href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.build_absolute_uri }}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-blue-400 transition">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="text-gray-500 dark:text-gray-400 hover:text-blue-600 transition">
                    <i class="fab fa-facebook"></i>
                </a>
            </div>
        </div>
    </div>
</article>

<!-- Comments Section -->
<div class="mt-8" id="comments">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Comments</h2>
    
    {% if user.is_authenticated %}
        <!-- Comment Form -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Leave a Comment</h3>
            <form class="comment-form" data-post-id="{{ post.id }}">
                {% csrf_token %}
                <div class="mb-4">
                    <textarea name="content" rows="4" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white dark:bg-gray-700 text-gray-800 dark:text-white" placeholder="Write your comment..." required></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition">Post Comment</button>
                </div>
            </form>
        </div>
    {% else %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6 text-center">
            <p class="text-gray-600 dark:text-gray-400 mb-4">
                <a href="{% url 'accounts:login' %}" class="text-blue-600 dark:text-blue-400 hover:underline">Login</a> to leave a comment.
            </p>
        </div>
    {% endif %}
    
    <!-- Comments List -->
    <div id="comments-container" class="space-y-6">
        {% for comment in comments %}
            {% if not comment.parent %}
                <div class="comment bg-white dark:bg-gray-800 rounded-lg shadow-md p-6" data-comment-id="{{ comment.id }}">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mr-4">
                            {% if comment.author.profile.profile_picture %}
                                <img src="{{ comment.author.profile.profile_picture.url }}" alt="{{ comment.author.username }}" class="w-10 h-10 rounded-full object-cover">
                            {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                                    <span class="text-gray-600 dark:text-gray-300 font-medium">{{ comment.author.username|first|upper }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-1">
                                    <a href="{% url 'accounts:profile' comment.author.username %}" class="font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition">{{ comment.author.username }}</a>
                                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ comment.created_at|date:"F d, Y, g:i A" }}</span>
                                </div>
                                <p class="text-gray-800 dark:text-gray-200">{{ comment.content }}</p>
                            </div>
                            <div class="mt-2 flex items-center space-x-4">
                                {% if user.is_authenticated %}
                                    <button class="reply-btn text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition" data-comment-id="{{ comment.id }}">
                                        <i class="far fa-reply mr-1"></i> Reply
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reply Form -->
                    {% if user.is_authenticated %}
                        <div class="reply-form-container hidden mt-4 ml-14">
                            <form class="comment-form" data-post-id="{{ post.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <div class="mb-2">
                                    <textarea name="content" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-white dark:bg-gray-700 text-gray-800 dark:text-white" placeholder="Write a reply..." required></textarea>
                                </div>
                                <div class="flex justify-end">
                                    <button type="button" class="cancel-reply-btn mr-2 px-3 py-1 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition">Cancel</button>
                                    <button type="submit" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition">Reply</button>
                                </div>
                            </form>
                        </div>
                    {% endif %}
                    
                    <!-- Replies -->
                    <div class="replies-container mt-4 ml-14">
                        {% for reply in comment.replies.all %}
                            <div class="reply mb-4 pl-4 border-l-2 border-gray-200 dark:border-gray-700">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 mr-3">
                                        {% if reply.author.profile.profile_picture %}
                                            <img src="{{ reply.author.profile.profile_picture.url }}" alt="{{ reply.author.username }}" class="w-8 h-8 rounded-full object-cover">
                                        {% else %}
                                            <div class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                                                <span class="text-gray-600 dark:text-gray-300 text-xs">{{ reply.author.username|first|upper }}</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-1">
                                                <a href="{% url 'accounts:profile' reply.author.username %}" class="font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition text-sm">{{ reply.author.username }}</a>
                                                <span class="text-xs text-gray-500 dark:text-gray-400">{{ reply.created_at|date:"F d, Y, g:i A" }}</span>
                                            </div>
                                            <p class="text-gray-800 dark:text-gray-200 text-sm">{{ reply.content }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% empty %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-8 text-center">
                <i class="far fa-comments text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600 dark:text-gray-400">No comments yet. Be the first to comment!</p>
            </div>
        {% endfor %}
    </div>
</div>

<!-- WebSocket for real-time comments -->
{% if user.is_authenticated %}
    <meta name="current-conversation-id" content="">
{% endif %}
{% endblock %}